# DRM Analyzers

This document describes the Roslyn analyzers, code fixes, and source generators included in the Digital Rights Management project.

## Analyzers

### DRM001: Entity Partial Class Rule
Enforces that all classes inheriting from `Entity` must be marked as `partial`.

**Examples**:
```csharp
// ❌ Error DRM001
public class Product : Entity { }

// ✅ Correct
public partial class Product : Entity { }
```

### DRM002: Entity Constructor Rule
Prevents manual implementation of parameterless constructors in Entity-derived classes.

**Examples**:
```csharp
public partial class Product : Entity 
{
    // ❌ Error DRM002
    protected Product() { }
}

// ✅ Correct - let source generator handle it
public partial class Product : Entity { }
```

### DRM003: Entity Instantiation Rule
Enforces that entities are only created using parameterized constructors.

**Examples**:
```csharp
// ❌ Error DRM003
var product = new Product();

// ✅ Correct
var product = new Product(id, name, price);
```

## Code Fixes

### EntityPartialAnalyzer  
- Applies to: DRM001
- Ensures Entity-derived classes are marked partial

### EntityConstructorCodeFix
- Applies to: DRM002
- Removes manual parameterless constructor implementations
- Determines correct accessibility based on class being sealed/non-sealed

### EntityInstantiationAnalyzer
- Applies to: DRM003
- Detects parameterless constructor calls for Entity-derived types

## Source Generators

### EntityConstructorGenerator
Generates parameterless constructors for Entity-derived classes.

**Generation Rules**:
- Non-sealed classes get `protected` constructor
- Sealed classes get `private` constructor 
- Adds appropriate warning suppressions
- Preserves any XML documentation

**Example Input**:
```csharp
public partial class Product : Entity { }
```

**Generated Output**:
```csharp
// <auto-generated/>
#pragma warning disable CS1591
#pragma warning disable CS8618
namespace YourNamespace
{
    partial class Product 
    {
        protected Product() { }
    }
}
```

## Configuration

### .editorconfig Settings
```editorconfig
# Default severity for analyzers
dotnet_analyzer_diagnostic.category-DRM.severity = error

# Individual rule configuration
dotnet_diagnostic.DRM001.severity = error  # Partial class requirement
dotnet_diagnostic.DRM002.severity = error  # Constructor generation
dotnet_diagnostic.DRM003.severity = error  # Instance creation
```

### Suppression
Rules can be suppressed using:
```csharp
#pragma warning disable DRM001 // Suppress specific rule
#pragma warning restore DRM001 // Re-enable rule
```

## Best Practices
1. Use partial classes for all domain entities
2. Let source generators handle parameterless constructors 
3. Implement only parameterized constructors manually
4. Use code fixes to automatically correct violations
5. Configure rules via .editorconfig for consistent application

## Implementation Notes
- Analyzers use incremental generation APIs
- Source generators follow the .NET source generator best practices
- Code fixes handle edge cases like nested types and file-scoped namespaces
- All analyzers run concurrently and are generation-aware
- Tests cover edge cases and generated code verification